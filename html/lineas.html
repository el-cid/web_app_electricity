<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Consumo anual</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.4/dc.css"/>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.12/crossfilter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.4/dc.js"></script>
    <style>
        .main-content{
              width: 1000px;
              margin: 0 auto;
              text-align: center;
              font-size: 12px;
            }
        .dc-chart {
            float: none;
        }
        .lineGraph g.axis.x g.tick text {
            text-anchor: end;
        }
        .lineGraph g.axis.x g.tick line,
        .lineGraph g.axis.y g.tick line {
            display: none;
        }
        .grid-line.vertical line, g.axis.y path.domain {
            opacity: 1;
            stroke: #cccccc;
        }
        #timeline{
          width: 750px;
          margin: 0 auto;
        }
        .time-series {
          width:50px;
          background: #eee;
          margin:0;
          padding:0;
          text-align:center;
          line-height: 30px;
          float: left;
        }
        .active {
          background: #b4b4b4;
          color:white;
        }
        .trend {
          font-weight: bold;
          font-size: 110%;
        }
        .pos {
          color: #1a9850;
        }
        .neg {
          color: #d73027;
        }
    </style>
    
</head>
<body>
    <section class="main-content">
        <h1>Consumo el√©ctrico regional anual</h1>
        <div id="timeline">
            <div class="time-series">BCA</div>
            <div class="time-series">BCS</div>
            <div class="time-series">CEL</div>
            <div class="time-series">NES</div>
            <div class="time-series">NOR</div>
            <div class="time-series">NTE</div>
            <div class="time-series">OCC</div>
            <div class="time-series">ORI</div>
            <div class="time-series">PEN</div>
        </div>
        
        <div class="lineGraph">
            <div class="chart-container">
                <div id="chart"></div>
            </div>
        </div>
    </section>
</body>
    <script>
        var data;
        var year;
        var consumptionArray;
        function requestData() {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.open("POST", "../php/consultaLineas.php", true);
            xmlhttp.setRequestHeader("Content-Type", "application/x-httpd-php");                  
            //xmlhttp.open("POST", "consumoLineas.json", true);
            xmlhttp.send();

            xmlhttp.onreadystatechange = function(){
                                            if( xmlhttp.readyState === 4 && xmlhttp.status === 200 ) {
                                                consumptionArray = JSON.parse( xmlhttp.responseText );
                                                data = consumptionArray["BCA"]["2017"];
                                                for ( i = 0; i < data.length; i++){
                                                    data[i]["value"] = +data[i]["value"];
                                                }                                                
                                                draw(data);
                                            }    
                                         };
        }

        function draw(data){
            var chartElementId = 'chart';
            var chartWidth = 800;
            var chartHeight = 400;
            var margin = 30;
            var lineColor = '#0000ff';
            

            var filteredGroup = {
                all: function() {
                        return data;
                    },
                ordering: function(item) {
                              return data.map( function(d) {
                                                   return d.key;
                                               }).indexOf(item.key);
                          },
                xAxisTickValues: data.map( function(d) {
                                               return d.key;
                                           })
            };
            var chart = dc.lineChart('#'+chartElementId);
            var ndx = crossfilter(data);
            var dimension = ndx.dimension( function(item) {
                                               return item.value;
                                            });
            chart.width(chartWidth)
                 .height(chartHeight)
                 .ordering(filteredGroup.ordering)
                 .colors([lineColor])
                 .brushOn(false)
                 .dotRadius(5)
                 .elasticX(true)
                 .xAxisPadding(0)
                 .xyTipsOn(true)
                 .margins({top: 10, right: 50, bottom: 100, left: 50})
                 .renderDataPoints({radius: 5, fillOpacity: 1, strokeOpacity: 1})
                 .clipPadding(40)
                 .dimension(dimension)
                 .renderVerticalGridLines(true)
                 .group(filteredGroup);

            _formatYAxis(chart, filteredGroup);
            _formatXAxis(chart, filteredGroup, chartWidth);

            chart.filter = function() {};
            chart.render();

            _rotateXAxisLabels(chart);
            _formatVerticalGridLines(chart);
            _repositionYAxis(chart);

        }

        function stringifyRegion(i){
            var month;
            switch (i){
                case 0:
                    month = "BCA"
                    break;
                case 1:
                    month = "BCS"
                    break;
                case 2:
                    month = "CEL"
                    break;
                case 3:
                    month = "NES"
                    break;
                case 4:
                    month = "NOR"
                    break;
                case 5:
                    month = "NTE"
                    break;
                case 6:
                    month = "OCC"
                    break;
                case 7:
                    month = "ORI"
                    break;
                case 8:
                    month = "PEN"
                    break;
            }
            return month;
        }
        
        var timeline = d3.selectAll(".time-series")
                         .on("mouseover", function(d, i) {
                                              year = stringifyRegion(i);
                                              d3.selectAll(".time-series")
                                                .attr("class", "time-series");
                                              this.className = "time-series active";
                                              data = consumptionArray[year]["2017"];
                                              for ( i = 0; i < data.length; i++){
                                                  data[i]["value"] = +data[i]["value"];
                                              }
                                              draw(data);
                                          });

        
        function formatDecimal(val) {
            if (isNaN(val)) {
                return "0.00";
            }
            else if (val != null) {
                return d3.format(",.2f")(val);
            }
            else {
                return "N/A";
            }
        }

        function _formatYAxis(chart, filteredGroup) {
            var units = ['','K','M','B','T','Q'];
            chart.yAxis().tickFormat( function(v) {
                                          var i, unit, raw, formatted;
                                          for (i=0; i < units.length; i++) {
                                              unit = Math.pow(1000,i);
                                              if (v >= unit && v < Math.pow(1000,(i+1))) {
                                                  raw = v/unit;
                                                  if (raw === Math.floor(raw)) {
                                                      formatted = raw + units[i];
                                                  } 
                                                  else {
                                                      formatted = formatDecimal(raw);
                                                      // if the formatted value is 3.50, pare it down to 3.5
                                                      if (formatted.charAt(formatted.length-1) === '0') {
                                                          formatted = formatted.substring(0,(formatted.length-1));
                                                       }
                                                      formatted = formatted + units[i];
                                                  }
                                                  return formatted;
                                              }
                                          }
                                          return v;
                                      });
            chart.yAxis().tickSize(3,0);
            chart.y(d3.scale.linear().domain(d3.extent(filteredGroup.all(), function(item) {
                                                                                return item.value;
                                                                            })).nice());
        }

        function _repositionYAxis(chart) {
            var yAxis = chart.select('g.axis.y').remove();
            chart.select('svg > g > g.grid-line.vertical').select( function() {
                                                                       return this.parentNode.insertBefore(yAxis.node(), this);
                                                                   });
        }

        function _formatXAxis(chart, filteredGroup, chartWidth) {
            var ordinalScale = d3.scale.ordinal().domain(filteredGroup.xAxisTickValues);
            chart._outerRangeBandPadding(0);
            chart.x(ordinalScale).xUnits(dc.units.ordinal)
        }

        function _formatVerticalGridLines(chart) {
          chart.selectAll('.grid-line.vertical line, g.axis.y path.domain').attr('stroke-dasharray', '5,3');
        }

        function _rotateXAxisLabels(chart) {
          chart.selectAll('g.axis.x g.tick text')
            .attr('transform', 'rotate(-60 0 12)')
            .attr('style', null);
        }
        window.onload = requestData;
    </script>
</html>
